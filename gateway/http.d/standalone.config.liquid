{% for server in standalone.server.listen %}
server {
    listen {{ server.port }} default_server;
    {%- capture server_name -%}{{ server.name | default: 'default' }}{%- endcapture %}
    set $port_name {{ server_name }};
    server_name {{ server_name }};

    set $ctx_ref -1;

    location / {
        rewrite_by_lua_block {
          require('resty.ctx').stash()
          require('apicast.executor'):rewrite()
        }
        access_by_lua_block { require('apicast.executor'):access() }
        content_by_lua_block { require('apicast.executor'):content() }
        post_action @post_action;
    }

    body_filter_by_lua_block { require('apicast.executor'):body_filter() }
    header_filter_by_lua_block { require('apicast.executor'):header_filter() }

    location @post_action {
      internal;

      proxy_pass_request_headers off;

      rewrite_by_lua_block { require('resty.ctx').apply() }
      content_by_lua_block { require('apicast.executor'):post_action() }
      log_by_lua_block { require('apicast.executor'):log() }
    }
}
{% endfor %}
